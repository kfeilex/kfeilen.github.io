/*
Kenny Feilen 
220 DAD 
5/16/2020
*/

LOAD DATA INFILE '/home/codio/workspace/orders.csv'
INTO TABLE Orders
FIELDS TERMINATED BY  ','
LINES TERMINATED BY  '\r\n';

CREATE TABLE Customers (
    CustomerID INT NOT NULL,
    FirstName VARCHAR(25),
    LastName VARCHAR(25),
    Street VARCHAR(50),
    City VARCHAR(50),
    State VARCHAR(25),
    ZipCode INT NOT NULL,
    Telephone VARCHAR(15),
    PRIMARY KEY (CustomerID));


CREATE TABLE RMA (
    RMAID INT NOT NULL,
    OrderID INT NOT NULL,
    Step VARCHAR(15),
    Status VARCHAR(50),
    Reason VARCHAR(25),
    PRIMARY KEY (RMAID)),
FOREIGN KEY (OrderID) REFERENCES Orders(OrderID));


CREATE TABLE Orders (
    OrderID INT NOT NULL,
    CustomerID INT NOT NULL,
    SKU VARCHAR(20),
    Description VARCHAR(50),
    PRIMARY KEY (OrderID));


SELECT Customers.State AS STATE,
    (COUNT(*) * 100 / (SELECT COUNT(*),
    FROM Orders INTER JOIN RMA ON Orders.OrdersID = RMA.OrderID)),
    AS RETURN_PERCENTAGE,
    FROM Orders INNER JOIN RMA ON Orders.OrderID = RMA.OrderID,
    INNER JOIN Customers ON Customers.CustomersID = Orders.CustomerID,
    GROUP BY STATE,
    ORDER BY RETURN_PERCENTAGE DESC LIMIT 5;


SELECT sku AS PRODUCT_SKU,
    description AS PRODUCT_DESCRIPTION,
    (COUNT(*) * 100 / (SELECT COUNT(*),
    FROM Orders INTER JOIN RMA ON Orders.OrdersID = RMA.OrderID)),
    AS RETURN_PERCENTAGE,
    FROM Orders INNER JOIN RMA ON Orders.OrderID = RMA.OrderID,
    GROUP BY PRODUCT_SKU,
    ORDER BY RETURN_PERCENTAGE DESC;


SELECT Customers.State AS STATE,
    (COUNT(*) AS PRODUCT_SALES_NUMBER,
    FROM Customers INTER JOIN Orders ON,
    Customers.CustomersID = Orders.CustomersID)),
    GROUP BY STATE,
    ORDER BY RETURN_PERCENTAGE DESC LIMIT 10;


SELECT * FROM Customers,
    INNER JOIN Orders on,
    Customers.CustomerID = Orders.CustomerID,
    WHERE UPPER (Customers.city) = "Framingham",
    AND UPPER (Customers.state) = "Massachusetts";


SELECT COUNT (*) FROM Customers,
    INNER JOIN Orders on,
    Customers.CustomerID = Orders.CustomerID,
    WHERE UPPER (Customers.state) = "Massachusetts";


UPDATE RMA SET STATUS = 'Complete',
    Step = 'Credit Customer Account'
    WHERE OrderID = 5175;

SELECT Customers.state AS STATE, COUNT(*) AS PRODUCT_SALES_NUMBER
FROM Customers INNER JOIN Orders ON Customers.CustomerID = Orders.CustomerID
GROUP BY STATE
ORDER BY PRODUCT_SALES_NUMBER DESC
LIMIT 10;

SELECT COUNT(*) AS PRODUCT_SALES_NUMBER, Orders.SKU AS PRODUCT_SKU,
Orders.Description AS PRODUCT_DESCRIPTION
FROM Orders
GROUP BY PRODUCT_SKU
ORDER BY PRODUCT_SALES_NUMBER DESC
LIMIT 3;

SELECT COUNT(*) AS PRODUCT_SALES_NUMBER, Orders.SKU AS PRODUCT_SKU,
Orders.Description AS PRODUCT_DESCRIPTION
FROM Orders INNER JOIN Customers on Orders.CustomerID = Customers.CustomerID
WHERE UPPER(STATE) IN ('VIRGINIA','NORTH CAROLINA','SOUTH CAROLINA','GEORGIA')
GROUP BY PRODUCT_SKU
ORDER BY PRODUCT_SALES_NUMBER DESC
LIMIT 3;

SELECT COUNT(*) RETURNED_AMOUNT, Orders.SKU AS PRODUCT_SKU,
Orders.Description AS PRODUCT_DESCRIPTION
FROM Orders INNER JOIN RMA on Orders.OrderID = RMA.OrderID
WHERE UPPER(Status) = 'COMPLETE'
GROUP BY PRODUCT_SKU
ORDER BY RETURNED_AMOUNT DESC
LIMIT 3;

SELECT COUNT(*) RETURNED_AMOUNT, Orders.SKU AS PRODUCT_SKU,
Orders.Description AS PRODUCT_DESCRIPTION
FROM Orders INNER JOIN RMA on Orders.OrderID = RMA.OrderID
INNER JOIN Customers ON Orders.CustomerID = Customers.CustomerID
WHERE UPPER(State) IN ('WASHINGTON','OREGON','IDAHO','MONTANA')
AND UPPER(STATUS) = 'COMPLETE'
GROUP BY PRODUCT_SKU
ORDER BY RETURNED_AMOUNT DESC
LIMIT 3;

DELETE FROM RMA WHERE UPPER (Reason) = 'REJECTED';

